<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live QR/Barcode Scanner</title>
  <script src="https://unpkg.com/@zxing/browser@latest"></script>
</head>
<body>
  <h1>QR/Barcode Scanner</h1>
  <button onclick="startScanner()">Start Camera</button>
  <video id="video" width="300" height="200" style="border:1px solid #333"></video>

  <h2>Transaction History</h2>
  <table border="1" id="transactionHistory">
    <thead>
      <tr>
        <th>Item</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="exportCSV()">Export to CSV</button>

  <script>
    const { BrowserMultiFormatReader } = ZXingBrowser;
    const codeReader = new BrowserMultiFormatReader();
    const transactionHistory = [];

    async function startScanner() {
      const videoElement = document.getElementById('video');

      try {
        const devices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
        if (devices.length === 0) {
          alert('No camera found');
          return;
        }

        const selectedDeviceId = devices[0].deviceId;

        codeReader.decodeFromVideoDevice(selectedDeviceId, videoElement, (result, err, controls) => {
          if (result) {
            const text = result.getText();
            const timestamp = new Date().toLocaleString();

            // Prevent duplicates in rapid succession
            const lastEntry = transactionHistory[transactionHistory.length - 1];
            if (!lastEntry || lastEntry.item !== text) {
              transactionHistory.push({ item: text, timestamp });
              updateTable();
            }
          }

          if (err && !(err instanceof ZXingBrowser.NotFoundException)) {
            console.error(err);
          }
        });
      } catch (e) {
        console.error(e);
        alert('Camera access error: ' + e);
      }
    }

    function updateTable() {
      const tbody = document.querySelector("#transactionHistory tbody");
      tbody.innerHTML = "";
      transactionHistory.forEach(entry => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${entry.item}</td><td>${entry.timestamp}</td>`;
        tbody.appendChild(row);
      });
    }

    function exportCSV() {
      let csv = "Item,Timestamp\n";
      transactionHistory.forEach(entry => {
        csv += `${entry.item},${entry.timestamp}\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "transaction_history.csv";
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
