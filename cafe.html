<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Camera and Scan</title>
    <script src="https://unpkg.com/@zxing/library@0.18.7/dist/index.min.js"></script>
</head>
<body>
    <button onclick="openCamera()">Open Camera</button>
    <video id="video" width="300" height="200" style="border: 1px solid black"></video>

    <h2>TRANSACTION HISTORY</h2>
    <table id="transactionHistory" border="1">
        <thead>
            <tr>
                <th>Item</th>
                <th>Details</th>
                <th>Timestamp</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <button onclick="exportCSV()">Export to CSV</button>

    <script>
        const transactionHistory = [];
        const codeReader = new ZXing.BrowserMultiFormatReader();

        async function openCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('video').srcObject = stream;

                // Start scanning
                startScanning(stream);
            } catch (err) {
                alert("Error accessing camera: " + err);
            }
        }

        function startScanning(stream) {
            const videoElement = document.getElementById('video');

            // Continuously scan the video feed
            setInterval(() => {
                if (videoElement.readyState === 4) {  // Ensure video has loaded
                    codeReader.decodeFromVideoElement(videoElement)
                        .then(result => {
                            const scannedData = result.getText();
                            const timestamp = new Date().toLocaleString();
                            transactionHistory.push({ item: scannedData, details: result.getText(), timestamp });

                            // Update the transaction history table
                            updateTransactionHistory();
                        })
                        .catch(err => {
                            // Handle decoding error
                        });
                }
            }, 1000); // Scan every second
        }

        function updateTransactionHistory() {
            const tableBody = document.getElementById('transactionHistory').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ''; // Clear the existing table body

            transactionHistory.forEach((transaction) => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = transaction.item;
                row.insertCell(1).textContent = transaction.details;
                row.insertCell(2).textContent = transaction.timestamp;
            });
        }

        function exportCSV() {
            let csvContent = "Item,Details,Timestamp\n";
            transactionHistory.forEach((transaction) => {
                csvContent += `${transaction.item},${transaction.details},${transaction.timestamp}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'transaction_history.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
