<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Camera and Scan</title>
    <script src="https://unpkg.com/@zxing/library@0.18.7/dist/index.min.js"></script>
</head>
<body>
    <button onclick="openCamera()">Open Camera</button>
    <input type="file" id="cameraInput" accept="image/*" style="display:none" capture="camera">

    <h2>Transaction History</h2>
    <table id="transactionHistory" border="1">
        <thead>
            <tr>
                <th>Item</th>
                <th>Details</th>
                <th>Timestamp</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <button onclick="exportCSV()">Export to CSV</button>

    <script>
        const transactionHistory = [];
        const codeReader = new ZXing.BrowserMultiFormatReader();

        function openCamera() {
            document.getElementById('cameraInput').click();
        }

        document.getElementById('cameraInput').addEventListener('change', handleImageUpload);

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function() {
                    const img = new Image();
                    img.src = reader.result;
                    img.onload = function() {
                        scanBarcode(img);
                    };
                };
                reader.readAsDataURL(file);
            }
        }

        function scanBarcode(img) {
            codeReader.decodeFromImage(img).then(result => {
                const scannedData = result.getText();
                const timestamp = new Date().toLocaleString();
                transactionHistory.push({ item: scannedData, details: result.getText(), timestamp });

                // Update the transaction history table
                updateTransactionHistory();

            }).catch(err => {
                alert("Error scanning barcode/QR code: " + err);
            });
        }

        function updateTransactionHistory() {
            const tableBody = document.getElementById('transactionHistory').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ''; // Clear the existing table body

            transactionHistory.forEach((transaction) => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = transaction.item;
                row.insertCell(1).textContent = transaction.details;
                row.insertCell(2).textContent = transaction.timestamp;
            });
        }

        function exportCSV() {
            let csvContent = "Item,Details,Timestamp\n";
            transactionHistory.forEach((transaction) => {
                csvContent += `${transaction.item},${transaction.details},${transaction.timestamp}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'transaction_history.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
